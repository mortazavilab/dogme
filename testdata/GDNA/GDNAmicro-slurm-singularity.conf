params {
    sample = 'GDNAmicro'
    //readType can either be 'RNA', 'DNA' or 'CDNA'
    readType = 'DNA'
    // change this value if 0.9 is too strict
    // if set to null or '' then modkit will determine its threshold by sampling reads. 
    modkitFilterThreshold = 0.9
    // modification type should be set as necessary if different from 'inosine_m6A,pseU,m5C' for RNA and '5mCG_5hmCG,6mA' for DNA. 
    modifications ='5mCG_5hmCG,6mA'
    //change setting if necessary 
    //for minitest, go with minimum Coverage
    minCov = 1
    perMod = 5
    // change if the launch directory is not where the pod5 and output directories should go
    topDir = "${launchDir}"

    scriptEnv = "${launchDir}/dogme.profile"

    // needs to be modified to match the right genomic reference
    
    genome_annot_refs = [
        [name: 'mm39', genome: '/share/crsp/lab/seyedam/share/genomeRef/IGVFFI9282QLXO.fasta', annot: '/share/crsp/lab/seyedam/share/genomeRef/IGVFFI4777RDZK.gtf']
    ]
    
    kallistoIndex = '/share/crsp/lab/seyedam/share/bridge_dRNA/kallistoref/mm39GencM36_k63.idx'
    t2g = '/share/crsp/lab/seyedam/share/bridge_dRNA/kallistoref/mm39GencM36_k63.t2g'

    //default accuracy is sup
    // for minitest, use hac
    accuracy = "hac"
    // change this value if 0.9 is too strict
    // if set to null or '' then modkit will determine its threshold by sampling reads. 
    modkitFilterThreshold = 0.9 


    // these paths are all based on the topDir and sample name
    // dogme will populate all of these folders with its output
    modDir = "${topDir}/dorModels"
    dorDir = "${topDir}/dor12-${sample}"
    podDir = "${topDir}/pod5"
    bamDir = "${topDir}/bams"
    annotDir = "${topDir}/annot"
    bedDir = "${topDir}/bedMethyl"
    fastqDir = "${topDir}/fastqs"
    kallistoDir = "${topDir}/kallisto"
    tmpDir = '/tmp'  // Temporary directory for disk-based sorting
}

singularity {
    enabled = true
    autoMounts = true
}

process {
    // <-- Container Settings ---
    container = 'ghcr.io/mortazavilab/dogme-pipeline:latest'
    containerOptions = "--bind /dfs9,/share/crsp/lab" // Make HPC storage visible to container
    beforeScript = 'export PATH=/opt/conda/bin:$PATH'

    // --- Slurm Executor ---
    executor = 'slurm'
    cpuPartition = 'standard'
    gpuPartition = 'gpu'
    cpuAccount = 'SEYEDAM_LAB'
    gpuAccount = 'SEYEDAM_LAB_GPU'

    // General default settings - adjust as necessary
    cpus = 12                      
    memory = '64 GB'               
    time = '8:00:00'           
    clusterOptions = "--account=${cpuAccount}"
    queue = "${cpuPartition}"

    withName: 'extractfastqTask' {
        // Matches the script's thread count and gives safe memory buffer
        cpus = 6
        memory = '24 GB' 
        time = '4 h'
    }

    withName: 'doradoTask' {
        clusterOptions = "--account=${gpuAccount} --gres=gpu:A100:1 --output=logs/doradoTask-%j.out --error=logs/doradoTask-%j.err"
        memory = '9 GB'  // Increase if necessary
        cpus = 4         // dorado is more GPU intensive than CPU intensive
        queue = "${gpuPartition}"
        containerOptions = "--nv --bind /dfs9,/share/crsp/lab" // <-- Add --nv for GPU access
    }
    
     withName: 'openChromatinTaskBg' {
        clusterOptions = "--account=${gpuAccount} --output=logs/modkitOpenTask-%j.out --error=logs/modkitOpenTask-%j.err"
        memory = '9 GB'  // Increase if necessary
        cpus = 4         // modkit for open chromatin is more GPU intensive than CPU intensive
        queue = "${gpuPartition}"
    }

    withName: 'minimapTask' {
        memory = '120 GB'  // Increase memory for minimap2
    }
}

timeline {
    enabled = true
    file = "${params.sample}_timeline.html"
}

report {
    enabled = true
    file = "${params.sample}_report.html"
}

trace {
    enabled = true
    file = "${params.sample}_trace.txt"
}
